"use strict";(self.webpackChunk_standardnotes_web=self.webpackChunk_standardnotes_web||[]).push([[108],{33108:(e,t,s)=>{s.r(t),s.d(t,{default:()=>G});var a=s(52322),n=s(2784),r=s(38318),i=s(91819),c=s(48518),o=s(47931),l=s(20896),d=s(37211),u=s(48667);async function p(e){const[t]=await u.tabs.query({active:!0,currentWindow:!0,windowType:"normal"});if(t&&t.id)return await u.tabs.sendMessage(t.id,e)}var m=s(84075),f=s(29894),x=s(54569),h=s(31031),g=s(94900),y=s(67743),b=s(41421),w=s(34521),v=s(93261);const j=new RegExp("^(?:[a-z+]+:)?//","i");var C=s(59846),S=s(32839),N=s(61659),k=s(66743),E=s(756),Z=s(41707);const F=e=>{let{note:t,linkingController:s,clearClip:r,isFirefoxPopup:i}=e;const l=(0,c.I)(),d=(0,n.useRef)(new N.I(t,l.items,l.mutator,l.sessions,l.sync,l.alerts,l.isNativeMobileWebUseCase));(0,n.useEffect)((()=>{const e=d.current;return()=>{e.deinit()}}),[]);const[u,p]=(0,n.useState)((()=>t.title));(0,n.useEffect)((()=>{d.current.saveAndAwaitLocalPropagation({title:u,isUserModified:!0,dontGeneratePreviews:!0})}),[l.items,u]);const f=(0,n.useCallback)((async(e,t)=>{d.current.saveAndAwaitLocalPropagation({text:e,isUserModified:!0,previews:{previewPlain:t,previewHtml:void 0}})}),[]),[x,h]=(0,n.useState)(!1),g=(0,n.useCallback)((async()=>{await(0,m.VG)({text:"Are you sure you want to discard this clip?",confirmButtonText:"Discard",confirmButtonStyle:"danger"})&&(h(!0),l.mutator.deleteItem(t).then((()=>l.sync.sync())).then((()=>{i&&window.close(),r()})).catch(console.error).finally((()=>h(!1))))}),[l.mutator,l.sync,r,i,t]);return(0,a.jsxs)("div",{className:"",children:[(0,a.jsxs)("div",{className:"border-b border-border p-3",children:[(0,a.jsxs)("div",{className:"mb-3 flex w-full items-center gap-3",children:[!i&&(0,a.jsxs)(E.Z,{className:"flex items-center justify-center",fullWidth:!0,onClick:r,disabled:x,children:[(0,a.jsx)(o.Z,{type:"arrow-left",className:"mr-2"}),"Back"]}),(0,a.jsx)(E.Z,{className:"flex items-center justify-center",fullWidth:!0,primary:!0,colorStyle:"danger",onClick:g,disabled:x,children:x?(0,a.jsx)(Z.Z,{className:"h-6 w-6 text-danger-contrast"}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{type:"trash-filled",className:"mr-2"}),"Discard"]})})]}),(0,a.jsx)("input",{className:"w-full text-base font-semibold",type:"text",value:u,onChange:e=>{p(e.target.value)}}),(0,a.jsx)(k.Z,{linkingController:s,item:t,hideToggle:!0})]}),(0,a.jsx)("div",{className:"p-3",children:(0,a.jsx)(C.I,{initialValue:t.text,children:(0,a.jsx)(S.k,{onChange:f})})})]})};var P=s(73703),I=s(38232),T=s(5778),U=s(57751),A=s(81959),B=s(26013),R=s(75711),D=s(61293);const G=e=>{let{applicationGroup:t}=e;const s=(0,c.I)(),[C,S]=(0,n.useState)();(0,n.useEffect)((()=>{u.windows.getCurrent({populate:!0}).then((e=>{S(e)})).catch(console.error)}),[]);const N=!!C&&"popup"===C.type&&!1===C.incognito,[k,G]=(0,n.useState)((()=>s.sessions.getUser())),[O,V]=(0,n.useState)(!1),[L,M]=(0,n.useState)(!1);(0,n.useEffect)((()=>{s.sessions.refreshSessionIfExpiringSoon().catch(console.error)}),[s.sessions]);const[Y,W]=(0,n.useState)((()=>s.features.getFeatureStatus(f.NativeFeatureIdentifier.create(f.NativeFeatureIdentifier.TYPES.Clipper).getValue())===f.FeatureStatus.Entitled)),K=(0,I.Y)(Y),_=s.hasValidFirstPartySubscription();(0,n.useEffect)((()=>s.addEventObserver((async e=>{switch(e){case f.ApplicationEvent.SignedIn:case f.ApplicationEvent.SignedOut:case f.ApplicationEvent.UserRolesChanged:G(s.sessions.getUser()),W(s.features.getFeatureStatus(f.NativeFeatureIdentifier.create(f.NativeFeatureIdentifier.TYPES.Clipper).getValue())===f.FeatureStatus.Entitled);break;case f.ApplicationEvent.FeaturesAvailabilityChanged:W(s.features.getFeatureStatus(f.NativeFeatureIdentifier.create(f.NativeFeatureIdentifier.TYPES.Clipper).getValue())===f.FeatureStatus.Entitled);break;case f.ApplicationEvent.SyncStatusChanged:case f.ApplicationEvent.FailedSync:{const e=s.sync.getSyncStatus();V(e.syncInProgress),M(e.hasError());break}}}))),[s]);const z=(0,T.Z)(f.PrefKey.ClipperDefaultTagUuid),[q,J]=(0,n.useState)(),H=(0,I.Y)(q);(0,n.useEffect)((()=>{if(!z)return void J(void 0);const e=s.items.findItem(z);J(e)}),[z,s]);const X=(0,n.useCallback)((e=>{s.setPreference(f.PrefKey.ClipperDefaultTagUuid,e.uuid)}),[s]),Q=(0,n.useCallback)((async()=>{s.setPreference(f.PrefKey.ClipperDefaultTagUuid,void 0)}),[s]),[$,ee]=(0,n.useState)(),te=(0,n.useCallback)((()=>{ee(r.V.Register)}),[ee]),se=(0,n.useCallback)((()=>{ee(r.V.SignIn)}),[ee]),ae=(0,n.useCallback)((async()=>{await(0,m.VG)({title:"Sign Out",text:"Are you sure you want to sign out?",confirmButtonText:"Sign Out",confirmButtonStyle:"danger",cancelButtonText:"Cancel"})&&await s.user.signOut()}),[s.user]),[ne,re]=(0,n.useState)(!1);(0,n.useEffect)((()=>{p({type:"toggle-screenshot-mode",enabled:ne})}),[ne]);const[ie,ce]=(0,n.useState)(!1);(0,n.useEffect)((()=>{if(k)try{(async()=>{ce(Boolean(await p({type:"has-selection"})))})()}catch(e){console.error(e)}}),[k]);const[oe,le]=(0,n.useState)();(0,n.useEffect)((()=>{(async()=>{const e=await u.storage.local.get("clip");e.clip&&(le(e.clip),u.storage.local.remove("clip"))})()}),[]);const de=(0,n.useCallback)((()=>{le(void 0)}),[]),[ue,pe]=(0,n.useState)();(0,n.useEffect)((()=>{K.current&&async function(){if(!oe)return void pe(void 0);if(!oe.content)return void(0,x.fz)({type:x.pC.Error,message:"No content to clip"});if(oe.isScreenshot){const e=await fetch(oe.content).then((e=>e.blob())),t=new File([e],"".concat(oe.title," - ").concat(oe.url,".png"),{type:"image/png"}),a=await s.filesController.uploadNewFile(t).catch(console.error);return void(a&&H.current&&await s.linkingController.linkItems(a,H.current))}const e=await(async e=>{const t=(0,y.D)({namespace:"BlocksEditor",theme:w.Z,editable:!1,onError:e=>console.error(e),nodes:[...b.G]}),s=new URL(e.url);return await new Promise((s=>{t.update((()=>{const a=new DOMParser,n=a.parseFromString('<p>Clip source: <a href="'.concat(e.url,'">').concat(e.url,"</a></p>"),"text/html"),r=(0,g.s)(t,n).concat((0,h.BE)(),(0,h.BE)());if((0,h.Gv)().select(),(0,h.od)(r),"string"!=typeof e.content)throw new Error("Clip payload content is not a string");const i=a.parseFromString(e.content,"text/html"),c=(0,g.s)(t,i),o=[];c.forEach((e=>{const t=e.getType();if("text"===t||"link"===t){const t=(0,h.BE)();return t.append(e),void o.push(t)}o.push(e),o.push((0,h.BE)())})),(0,h.Gv)().selectEnd(),(0,h.od)(o.concat((0,h.BE)())),s()}))})),await new Promise((e=>{t.update((()=>{(0,h.K8)(v.GR).forEach((e=>{const t=e.getURL();if(!j.test(t)){const a=new URL(t,s);e.setURL(a.toString())}})),e()}))})),JSON.stringify(t.getEditorState().toJSON())})(oe),t=s.items.createTemplateItem(f.ContentType.TYPES.Note,{title:oe.title,text:e,editorIdentifier:f.NativeFeatureIdentifier.TYPES.SuperEditor,noteType:f.NoteType.Super,references:[]}),a=await s.mutator.insertItem(t);H.current&&await s.linkingController.linkItems(a,H.current),pe(a),(0,x.fz)({type:x.pC.Success,message:"Note clipped successfully"});const n=await s.sync.getRawSyncRequestForExternalUse([a]);n&&u.runtime.sendMessage({type:"run-http-request",payload:n}).catch(console.error)}().catch(console.error)}),[s.filesController,s.items,s.linkingController,s.mutator,s.sync,oe,H,K]);const me=(0,n.useCallback)((async()=>{_?await s.openSubscriptionDashboard.execute():await s.openPurchaseFlow(),window.close()}),[s,_]);return k&&!Y?(0,a.jsxs)("div",{className:"px-3 py-3",children:[(0,a.jsx)("div",{className:"mx-auto mb-5 flex h-24 w-24 items-center justify-center rounded-[50%] bg-contrast","aria-hidden":!0,children:(0,a.jsx)(o.Z,{className:"h-12 w-12 ".concat(P.K),size:"custom",type:P._})}),(0,a.jsx)("div",{className:"mb-1 text-center text-lg font-bold",children:"Enable Advanced Features"}),(0,a.jsxs)("div",{className:"mb-3 text-center",children:["To take advantage of ",(0,a.jsx)("span",{className:"font-semibold",children:"Web Clipper"})," and other advanced features, upgrade your current plan."]}),(0,a.jsx)(E.Z,{className:"mb-2",fullWidth:!0,primary:!0,onClick:me,children:"Upgrade"}),(0,a.jsx)(E.Z,{fullWidth:!0,onClick:ae,children:"Sign out"})]}):ue?(0,a.jsx)(F,{note:ue,linkingController:s.linkingController,clearClip:de,isFirefoxPopup:N},ue.uuid):k?(0,a.jsx)("div",{className:"bg-contrast p-3",children:(0,a.jsxs)(l.Z,{a11yLabel:"Extension menu",className:"rounded border border-border bg-default",children:[ie&&(0,a.jsxs)(d.Z,{className:"border-b border-border",disabled:ne,onClick:async()=>{const e=await p({type:"get-selection"});e&&le(e)},children:[(0,a.jsx)(o.Z,{type:"paragraph",className:"mr-2 text-info"}),"Clip text selection"]}),(0,a.jsxs)(d.Z,{onClick:async()=>{const e=await p({type:"get-full-page"});e&&le(e)},children:[(0,a.jsx)(o.Z,{type:"notes-filled",className:"mr-2 text-info"}),ne?"Capture visible":"Clip full page"]}),(0,a.jsxs)(d.Z,{disabled:ne,onClick:async()=>{const e=await p({type:"get-article"});e&&le(e)},children:[(0,a.jsx)(o.Z,{type:"rich-text",className:"mr-2 text-info"}),"Clip article"]}),(0,a.jsxs)(d.Z,{onClick:async()=>{p({type:"start-node-selection"}),window.close()},children:[(0,a.jsx)(o.Z,{type:"dashboard",className:"mr-2 text-info"}),"Select elements to ",ne?"capture":"clip"]}),(0,a.jsx)(D.Z,{checked:ne,onChange:function(e){re(e)},className:"flex-row-reverse gap-2",forceDesktopStyle:!0,children:"Clip as screenshot"}),(0,a.jsxs)("div",{className:"border-t border-border px-3 py-3  text-foreground",children:[q&&(0,a.jsxs)("div",{className:"flex items-center justify-between text-base",children:[(0,a.jsx)(B.Z,{className:"m-1 mr-2 min-w-0",link:(0,U.X)(q,"linked"),unlinkItem:Q,isBidirectional:!1}),(0,a.jsx)(R.Z,{label:"Remove default tag",gutter:2,children:(0,a.jsx)("button",{className:"rounded-full p-1 text-neutral hover:bg-contrast hover:text-info",onClick:Q,children:(0,a.jsx)(o.Z,{type:"clear-circle-filled"})})})]}),(0,a.jsx)(A.Z,{onSelection:X,placeholder:"Select tag to save clipped notes to...",contentTypes:[f.ContentType.TYPES.Tag],className:{input:"text-[0.85rem]"},comboboxProps:{placement:"top"}})]}),(0,a.jsxs)("div",{className:"flex items-center border-t border-border text-foreground",children:[(0,a.jsx)(o.Z,{type:"user",className:"mx-2"}),(0,a.jsx)("div",{className:"flex-grow py-2 text-sm font-semibold",children:k.email}),(0,a.jsx)("button",{className:"flex-shrink-0 border-l border-border px-2 py-2 hover:bg-info-backdrop focus:bg-info-backdrop focus:shadow-none focus:outline-none",onClick:ae,children:(0,a.jsx)(o.Z,{type:"signOut",className:"text-neutral"})})]}),O||L?(0,a.jsxs)("div",{className:(0,f.classNames)("flex items-center border-t border-border",L&&"text-danger"),children:[O&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(Z.Z,{className:"mx-2.5 h-4 w-4"}),(0,a.jsx)("div",{className:"flex-grow py-2 text-sm font-semibold text-info",children:"Syncing..."})]}),L&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(o.Z,{type:"warning",className:"mx-2.5"}),(0,a.jsx)("div",{className:"flex-grow py-2 text-sm font-semibold",children:"Unable to sync"})]})]}):null]})}):$?(0,a.jsx)("div",{className:"py-1",children:(0,a.jsx)(i.Z,{mainApplicationGroup:t,menuPane:$,setMenuPane:ee,closeMenu:()=>ee(void 0)})}):(0,a.jsxs)(l.Z,{a11yLabel:"User account menu",children:[(0,a.jsxs)(d.Z,{onClick:te,children:[(0,a.jsx)(o.Z,{type:"user",className:"mr-2 h-6 w-6 text-neutral md:h-5 md:w-5"}),"Create free account"]}),(0,a.jsxs)(d.Z,{onClick:se,children:[(0,a.jsx)(o.Z,{type:"signIn",className:"mr-2 h-6 w-6 text-neutral md:h-5 md:w-5"}),"Sign in"]})]})}}}]);
//# sourceMappingURL=108.app.js.map